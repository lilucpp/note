# 性能优化

主要的资源包括：CPU，内存，网络，磁盘IO。性能问题的本质，就是系统资源已经达到瓶颈，但请求的处理却还不够快，无法支撑更多的请求。

性能分析，就是找出应用或系统的瓶颈，并设法去避免或者缓解它们，从而更高效利用系统资源处理更多的请求。

## 平均负载

平均负载是指单位时间内，系统处于`可运行状态`和`不可中断状态`的平均进程数，也就是平均活跃进程数。

`可运行状态的进程`是指正在使用CPU或者正在等待CPU的进程，也就是我们常用`ps`命令看到的，处于R状态的进程。

`不可中断状态`的进程则是正处于内核态关键流程中的进程，并且这些流程是不可打断的，也就是我们在`ps`命令中看到的D状态。  

当平均负载高于CPU数量70%的时候，就应该分析排查负载高的问题。一旦负载过高，就可能导致进程响应变慢，进而影响服务的正常功能。

但 70% 这个数字并不是绝对的，最推荐的方法，还是把系统的平均负载监控起来，然后根据更多的历史数据，判断负载的变化趋势。当发现负载有明显升高趋势时，比如说负载翻倍了，你再去做分析和调查。

### tool

`stress mpstat uptime pidstat  htop  lsof`

### 平均负载与CPU使用率

平均负载不仅包括了正在使用CPU的进程，还包括等待CPU和等待IO的进程。CPU使用率是单位时间内CPU繁忙情况的统计。  

而 CPU 使用率，是单位时间内 CPU 繁忙情况的统计，跟平均负载并不一定完全对应。比如：

- CPU 密集型进程，使用大量 CPU 会导致平均负载升高，此时这两者是一致的；
- I/O 密集型进程，等待 I/O 也会导致平均负载升高，但 CPU 使用率不一定很高；
- 大量等待 CPU 的进程调度也会导致平均负载升高，此时的 CPU 使用率也会比较高。

测试1:CPU密集型进程

```shell
shell1: stress --cpu 1 --time 600
shell2:  watch -d uptime
shell3: mpstat -P ALL 5  # -P ALL 表示监控所有 CPU，后面数字 5 表示间隔 5 秒后输出一组数据

shell4: pidstat -u 5 1
13:37:07 UID PID %usr    %system %guest %wait %CPU   CPU Command
13:37:12 0   2962 100.00 0.00     0.00   0.00 100.00 1   stress
```

测试2:IO密集型进程

```shell
shell1: stress -i 1 --timeout 600
shell2:  watch -d uptime
shell3: mpstat -P ALL 5  # -P ALL 表示监控所有 CPU，后面数字 5 表示间隔 5 秒后输出一组数据
shell4:  pidstat -u 5 1 # 间隔 5 秒后输出一组数据，-u 表示 CPU 指标
```

测试3：大量进程的场景

当系统中运行进程超出 CPU 运行能力时，就会出现等待 CPU 的进程。

```shell
stress -c 8 --timeout 600
watch -d uptime
pidstat -u 5 1
```

###  小结
平均负载提供了一个快速查看系统整体性能的手段，反映了整体的负载情况。但只看平均负载本身，我们并不能直接发现，到底是哪里出现了瓶颈。所以，在理解平均负载时，也要注意：平均负载高有可能是 CPU 密集型进程导致的；平均负载高并不一定代表 CPU 使用率高，还有可能是 I/O 更繁忙了；当发现负载高的时候，你可以使用 mpstat、pidstat 等工具，辅助分析负载的来源。

## vmstat

命令的输出列显示了系统的各种性能指标。下面是每个列的含义：

1. procs（进程）
   - r：在运行队列中的进程数。
   - b：在等待I/O的进程数。
2. memory（内存）
   - swpd：已使用的虚拟内存大小（以千字节为单位）。
   - free：空闲内存大小（以千字节为单位）。
   - buff：用作缓冲区的内存大小（以千字节为单位）。
   - cache：用作缓存的内存大小（以千字节为单位）。
3. swap（交换）
   - si：从交换区读入内存的交换页数量（每秒，单位：块）。
   - so：写入交换区的交换页数量（每秒，单位：块）。
4. io（输入输出）
   - bi：从块设备读入的块数量（每秒）。
   - bo：写入块设备的块数量（每秒）。
5. system（系统）
   - in：每秒产生的中断数，包括时钟中断。
   - cs：每秒的上下文切换数。
6. cpu（CPU）
   - us：用户态CPU时间百分比（执行用户进程）。
   - sy：系统态CPU时间百分比（执行内核进程）。
   - id：空闲CPU时间百分比。
   - wa：等待I/O的CPU时间百分比。
   - st：被偷取的时间百分比，这部分时间是运行在其他虚拟机上的时间（在虚拟化环境中使用）。

这些指标提供了有关系统性能的全面视图，包括CPU使用情况、内存使用情况、I/O活动和进程状态等。

## 块大小

`sudo blockdev --getbsz /dev/sda`

## 磁盘性能指标

说到磁盘性能的衡量标准，必须要提到四个常见指标，也就是我们经常用到的，使用率、饱和

度、IOPS、吞吐量以及响应时间等。这四个指标，是衡量磁盘性能的基本指标。

- 使用率，是指磁盘处理 I/O 的时间百分比。过高的使用率（比如超过 80%），通常意味着磁

盘 I/O 存在性能瓶颈。

- 饱和度，是指磁盘处理 I/O 的繁忙程度。过高的饱和度，意味着磁盘存在严重的性能瓶颈。

当饱和度为 100% 时，磁盘无法接受新的 I/O 请求。

- IOPS（Input/Output Per Second），是指每秒的 I/O 请求数。

- 吞吐量，是指每秒的 I/O 请求大小。

- 响应时间，是指 I/O 请求从发出到收到响应的间隔时间。

这些指标，很可能是你经常挂在嘴边的，一讨论磁盘性能必定提起的对象。不过我还是要强调一点，不要孤立地去比较某一指标，而要结合读写比例、I/O 类型（随机还是连续）以及 I/O 的大小，综合来分析。举个例子，在数据库、大量小文件等这类随机读写比较多的场景中，IOPS 更能反映系统的整体性能；而在多媒体等顺序读写较多的场景中，吞吐量才更能反映系统的整体性能。

```shell
# -d -x 表示显示所有磁盘 I/O 的指标
$ iostat -d -x 1
r/s 和 w/s：读写请求数
rkB/s 和 wkB/s：每秒读写千字节数。(KB)
rrqm/s和 wrqm/s: 每秒合并的读/写请求数。（读请求百分比，写请求百分比）
r_await和w_await: 读/写请求处理完成等待时间。（毫秒）
aqu-sz: 平均请求队列长度。
rareq-sz: 平均读请求大小
wareq-sz: 平均写请求大小。
svctm: 处理i/o请求所需的平均时间（不包括等待时间）毫秒
%util: 磁盘处理I/O百分比。
```

- %util ，就是我们前面提到的磁盘 I/O 使用率；

- r/s+ w/s ，就是 IOPS；

- rkB/s+wkB/s ，就是吞吐量；

- r_await+w_await ，就是响应时间。

## 性能问题定位

先用 `top` 查看系统的 CPU 使用情况，发现 `iowait` 比较高；然后，又用 `iostat` 发现了磁盘的 I/O 使用率瓶颈，并用 `pidstat` 找出了大量 I/O 的进程；最后，通过 `strace` 和 `lsof`，我们找出了问题进程正在读写的文件，并最终锁定性能问题的来源，也可以用新工具 filetop 和 opensnoop ，从内核中跟踪系统调用，最终找出瓶颈的来源。



## 参考

- [1] [Linux 性能优化实战](https://time.geekbang.org/column/intro/100020901)

